---
title: "Comp to cell paper"
author: "Kent Riemondy RBI"
date: "2/24/2020"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
library(Seurat)
library(scbp)
library(tidyverse)
library(qs)
library(cowplot)
library(ComplexHeatmap)
library(here)

theme_set(theme_cowplot())
data_dir <- here("data")
```

```{r}
data_dir <- file.path(data_dir, "Wu_et_al_cell")
dir.create(data_dir, showWarnings = FALSE)

matrix_url <- "https://www.ncbi.nlm.nih.gov/geo/download/?acc=GSE138585&format=file&file=GSE138585%5FC0%5FC21%5FN0%5FN21%2EUMI%2Ecsv%2Egz"


if(!file.exists(file.path(data_dir, "matrix.tsv.gz"))){
  download.file(matrix_url, file.path(data_dir, "matrix.tsv.gz"))
} 

mat <- read_csv(file.path(data_dir, "matrix.tsv.gz"))
mat <- column_to_rownames(mat, "X1") 
mat <- as.matrix(mat)
mat <- as(mat, "sparseMatrix")
```


## recluster the cell paper data.

Got metadata from the authors. 

```{r}

so <- CreateSeuratObject(mat, names.delim = "-", names.field = 2) %>% 
  NormalizeData() %>% 
  FindVariableFeatures() %>% 
  ScaleData() %>% 
  RunPCA() %>% 
  RunUMAP(dims = 1:20) %>% 
  FindNeighbors(dims = 1:20) 

so <- FindClusters(so, resolution = c(0.1, 0.3, 0.5, 0.7, 0.9))

cluster_cols <- str_subset(colnames(so@meta.data), "RNA_snn")
plot_umap(so, cluster_cols)

so$coarse_clusters <- so$RNA_snn_res.0.1
so$fine_clusters <- so$RNA_snn_res.0.5

so$cell_type <- ifelse(as.character(so$fine_clusters) %in% 
                         c("0", "1", "2", "3", "4", "5", "9"),
                       "AEC2",
                       "Other")

# add annotaitons

sample_labels <- c(
  "1" = "control_day_0",
  "2" = "control_day_21",
  "3" = "cdc42ko_day_0",
  "4" = "cdc42ko_day_21")

so$sample <- sample_labels[as.character(so$orig.ident)]
```


```{r}
to_plot <- c(
  "sample",
  "cell_type",
  "coarse_clusters",
  "fine_clusters",
  "Krt8",
  "Cldn4",
  "Hopx",
  "Sftpc"
)
p  <- plot_umap(so, to_plot) 

p

p <- plot_grid(plotlist = p, 
          nrow = 3,
          ncol = 3)
dir.create("Wu_et_al_cell/figs")
save_plot("Wu_et_al_cell/figs/wu_et_al_reclustered_umaps.pdf",
          p,
          nrow = 3,
          ncol = 3,
          base_asp = 1.5)
```

get average expression per cluster

```{r}
so_sub <- subset(so, subset = cell_type == "AEC2")
Idents(so_sub) <- "fine_clusters"
avg_expr_fine <- log1p(AverageExpression(so_sub)$RNA)
colnames(avg_expr_fine ) <- str_c("AEC_cluster_", colnames(avg_expr_fine))

Idents(so_sub) <- "coarse_clusters"
avg_expr_coarse <- log1p(AverageExpression(so_sub)$RNA)
colnames(avg_expr_coarse ) <- str_c("AEC_cluster_", colnames(avg_expr_coarse))

write_csv(avg_expr_fine %>% rownames_to_column("Gene"), "Wu_et_al_cell/avg_expr_fine_wu_et_al.csv")

write_csv(avg_expr_coarse %>% rownames_to_column("Gene"), "Wu_et_al_cell/avg_expr_coarse_wu_et_al.csv")
```

```{r}
qsave(so, "Wu_et_al_cell/wu_et_al_so.qs")

so <- qread("Wu_et_al_cell/wu_et_al_so.qs")
wu_metadata <- so@meta.data
```

## atcell average expression correlatio heatmap

```{r}
cells_to_keep <- c(
  "Injured AEC2: Early Transdifferentiating",
  "Injured AEC2: Late Transdifferentiating",
  "Injured AEC2: Proliferating",
  "Other Injured AEC2",
  "Naive AEC2"
)

atcells_sub <- subset(atcells, subset = pretty_cell_labels %in% cells_to_keep)

Idents(atcells_sub) <- "pretty_cell_labels"
avg_expr_cell_types <- log1p(AverageExpression(atcells_sub)$RNA)

write_csv(avg_expr_cell_types %>% rownames_to_column("Gene"), "Wu_et_al_cell/avg_expr_cell_types_riemondy_et_al.csv")

hmap <- Heatmap(cor(avg_expr_cell_types, 
            avg_expr_fine, 
            method = "spearman"),
        name = "Spearman Cor",
        col = viridis::viridis(256),
        row_title = "Riemondy et. al. Cell types",
        column_title = "Wu et. al. clusters (fine clustering)")

pdf("Wu_et_al_cell/figs/cor_heatmap_fine_clusters.pdf")
draw(hmap)
dev.off()
hmap
hmap <- Heatmap(cor(avg_expr_cell_types, 
            avg_expr_coarse, 
            method = "spearman"),
        name = "Spearman Cor",
        col = viridis::viridis(256),
        row_title = "Riemondy et. al. Cell types",
        column_title = "Wu et. al. clusters (coarse clustering)")

pdf("Wu_et_al_cell/figs/cor_heatmap_coarse_clusters.pdf")
draw(hmap)
dev.off()

hmap
```


## Combine the data

```{r}
shared_genes <- intersect(rownames(so), rownames(atcells))

so <- so[shared_genes, ]
atcells <- atcells[shared_genes, ]
so2 <- merge(atcells, so)

so2$pretty_cell_labels <- ifelse(is.na(so2$pretty_cell_labels),
                                 str_c("Wu_et_al:", so2$cell_type),
                                 so2$pretty_cell_labels)
                                 
so2$study <- ifelse(is.na(so2$sample_names),
                    "Wu_et_al",
                    "Riemondy_et_al")

so2$sample_type <- ifelse(is.na(so2$sample_type),
                     str_c("Wt_et_al:", so2$sample),
                     so2$sample_type)
cells_to_keep <- c(
  "Injured AEC2: Early Transdifferentiating",
  "Injured AEC2: Late Transdifferentiating",
  "Injured AEC2: Proliferating",
  "Other Injured AEC2",
  "Naive AEC2",
  "Naive AEC1",
  "Wu_et_al:AEC2"
)
so2 <- subset(so2, subset = pretty_cell_labels %in% cells_to_keep)

so2 <- NormalizeData(so2) %>% 
  FindVariableFeatures() %>% 
  ScaleData() %>% 
  RunPCA() %>% 
  RunUMAP(dims = 1:20) %>% 
  FindNeighbors(dims = 1:20) 
```

```{r}
to_plot <- c(
  "pretty_cell_labels",
  "sample_type",
  "Krt8",
  "Cldn4",
  "Hopx",
  "Sftpc"
)

p  <- plot_umap(so2, 
                   to_plot[1:2], 
                   sorted = "random", 
                   pt_size = 0.0001, 
                   pt_alpha = 0.5, 
                   .cols = palette_OkabeIto_cell_labels,
                   legend_title = "") 

p <- append(p, plot_umap(so2, to_plot[3:6],  sorted = "random"))

p <- plot_grid(plotlist = p, 
          nrow = 3,
          ncol = 3)
dir.create("Wu_et_al_cell/figs")
save_plot("Wu_et_al_cell/figs/merged_nonharmonized_umaps.pdf",
          p,
          nrow = 3,
          ncol = 3,
          base_asp = 1.5)

```


```{r}
library(harmony)

so2 <- RunHarmony(so2,
             group.by.vars = "study",
             dims.use = 1:20,
             theta = 1)
so2 <- FindNeighbors(so2, reduction = "harmony", dims = 1:20) %>%
  RunUMAP(dims = 1:20,
          reduction = "harmony",
          reduction.name = "harmony_umap")

so2 <- FindClusters(so2, 
               resolution = c(0.1, 0.3, 0.5, 0.7, 0.9, 1.1))

cell_type_order <- c(
 "Naive AEC1",
  "Injured AEC2: Proliferating",
  "Injured AEC2: Late Transdifferentiating",
  "Other Injured AEC2",
  "Wu_et_al:AEC2",
  "Naive AEC2",
  "Injured AEC2: Early Transdifferentiating"
  
)

so2$pretty_cell_labels <- factor(so2$pretty_cell_labels, levels = cell_type_order)
so2$pretty_cell_labels <- as.character(so2$pretty_cell_labels)

palette_OkabeIto_cell_labels <- palette_OkabeIto[match(cells_to_keep, cell_type_order)]
plot_harmony(so2, "pretty_cell_labels", sorted = "random", 
             .cols = palette_OkabeIto_cell_labels)
```


```{r}
to_plot <- c(
  "pretty_cell_labels",
  "sample_type",
  "Krt8",
  "Cldn4",
  "Hopx",
  "Sftpc"
)

p  <- plot_harmony(so2, 
                   to_plot[1:2], 
                   sorted = "random", 
                   pt_size = 0.0001, 
                   pt_alpha = 0.5, 
                   .cols = palette_OkabeIto_cell_labels,
                   legend_title = "") 

p <- append(p, plot_harmony(so2, to_plot[3:6],  sorted = "random"))

p <- plot_grid(plotlist = p, 
          nrow = 3,
          ncol = 3)
dir.create("Wu_et_al_cell/figs")
save_plot("Wu_et_al_cell/figs/merged_harmonized_umaps.pdf",
          p,
          nrow = 3,
          ncol = 3,
          base_asp = 1.5)
```
 make a bunch of umaps split by study
 
 discrete stuff
```{r}

to_plot <- c(
  "pretty_cell_labels",
  "sample_type"
)

p <- map(to_plot,
    ~plot_harmony(so2, .x, group = "study",
          sorted = "random", 
          pt_size = 0.1)) %>% 
  plot_grid(plotlist = ., 
            nrow = length(to_plot),
            ncol = 1) 
p

save_plot("Wu_et_al_cell/figs/merged_harmonized_umap_split_by_study.pdf",
          p,
          nrow = length(to_plot),
          ncol = 1,
          base_asp = 2.0,
          limitsize = FALSE)
```

genes

```{r}
to_plot <- c("S100a6",
             "Sfn",
             "Tmsb10",
             "Anxa1",
             "Cldn4",
             "Clu",
             "AW112010",
             "Krt8",
             "Krt19",
             "Krt18",
             "Krt7",
             "Tnip3",
             "Tpm2",
             "Lgals1",
             "Sprr1a",
             "Anxa2",
             "Epcam",
             "Lgals3",
             "Hspb1",
             "2200002D01Rik")

p <- map(to_plot,
    ~plot_harmony(so2, .x, group = "study",
          sorted = "random", 
          pt_size = 0.1)) %>% 
  plot_grid(plotlist = ., 
            nrow = length(to_plot),
            ncol = 1) 
p

save_plot("Wu_et_al_cell/figs/merged_harmonized_umap_split_by_study_top_genes.pdf",
          p,
          nrow = length(to_plot),
          ncol = 1,
          base_asp = 1.5,
          limitsize = FALSE)
```


## Euler diagrams of markers

```{r}
our_markers <- readxl::read_excel("Wu_et_al_cell/2.14.2019_Suppl_Table_5.xlsx", sheet = 2)
wu_et_all_markers <- readxl::read_excel("Wu_et_al_cell/1-s2.0-S009286741931284X-mmc2.xlsx",
                                        col_names = c("Gene",
                                                      "AEC2_subpop1",
                                                      "AEC2_subpop2",
                                                      "fold_change"),
                                        skip = 2) %>% 
  filter(fold_change > 1)

strunz_et_al_markers <- map_dfr(1:4, ~readxl::read_excel("Wu_et_al_cell/ext_data/shiller_krt8_markers.xlsx",
                                                 sheet = .x))

joshi_et_al_markers <- read_csv("Wu_et_al_cell/ext_data/Rachel_Zemans/AT2_clean.markers.csv")

library(eulerr)
fit <- euler(list("Riemondy_et_al" = our_markers$Gene, 
                  "Wu_et_al" = wu_et_all_markers$Gene,
                  "Strunz_et_al" = strunz_et_al_markers$gene))

pdf("Wu_et_al_cell/figs/marker_overlap_3_studies.pdf")
plot(fit, 
     labels = TRUE,
     quantities = TRUE,
     fills = list(fill = palette_OkabeIto[1:4],
                  alpha = 0.5))
dev.off()

total_pop <- nrow(so2)
n_success_pop <- length(wu_et_all_markers$Gene)
total_test <- length(our_markers$Gene)
n_success_test <- length(intersect(wu_et_all_markers$Gene, our_markers$Gene))

phyper(420 - 1, 
       n_success_pop,
       total_pop - n_success_pop, 
       length(our_markers$Gene),
       lower.tail=FALSE)
```

```{r}
library(UpSetR)
(list("Riemondy_et_al" = our_markers$Gene, 
                  "Wu_et_al" = wu_et_all_markers$Gene,
                  "Strunz_et_al" = strunz_et_al_markers$gene,
      "Joshi_et_al"= joshi_et_al_markers$X1)
 

## Marker gene heatmap

```{r}

combined_markers <- inner_join(our_markers, wu_et_all_markers)  %>%
  mutate(fold_change_zemans = expm1(`Log Fold Change`), 
         avg_fc = (fold_change + fold_change_zemans) / 2)

fine_combined <- cbind(avg_expr_cell_types, avg_expr_fine)
fine_combined_zscore <- t(scale(t(fine_combined)))

hmap_ours <- Heatmap(fine_combined_zscore[our_markers$Gene[1:100], ],
        show_row_names = TRUE,
        cluster_rows = FALSE,
        col = viridis::viridis(256),
        name = "Mean expression\nZscore")
hmap_ours

hmap_theirs <- Heatmap(fine_combined_zscore[wu_et_all_markers$Gene[1:100], ],
        show_row_names = TRUE,
        cluster_rows = FALSE,
        col = viridis::viridis(256),
        name = "Mean expression\nZscore")

hmap_theirs

hmap_combined <- Heatmap(fine_combined_zscore[combined_markers$Gene[1:100], ],
        show_row_names = TRUE,
        cluster_rows = FALSE,
        col = viridis::viridis(256),
        name = "Mean expression\nZscore")

hmap_combined


pdf("Wu_et_al_cell/figs/heatmap_top100_cell_paper_markers.pdf",
    width = 7,
    height = 16)
draw(hmap_theirs)
dev.off()


pdf("Wu_et_al_cell/figs/heatmap_top100_our_paper_markers.pdf",
    width = 7,
    height = 16)
draw(hmap_ours)
dev.off()

pdf("Wu_et_al_cell/figs/heatmap_top100_combined_markers.pdf",
    width = 7,
    height = 16)
draw(hmap_combined)
dev.off()

write_tsv(combined_markers, "Wu_et_al_cell/combined_markers.tsv")
````

```{r}
library(qs)

#qsave(so2, "Wu_et_al_cell/zemans_wu_harmonized.qs")
so2 <- qread("Wu_et_al_cell/zemans_wu_harmonized.qs")
```


## Asbestos study

```{r}
load("Wu_et_al_cell/ext_data/Rachel_Zemans/AT2_clean.Robj")
ab_mdata <- AT2_clean@meta.data
AT2_clean$sample_type <- str_c("Joshi_et_al:", AT2_clean$stim)
AT2_clean$study <- "Joshi_et_al"
AT2_clean$pretty_cell_labels <- "Joshi_et_al:AEC2"
so2 <- merge(so2, AT2_clean)

```



```{r}
so2 <- NormalizeData(so2) %>% 
  FindVariableFeatures() %>% 
  ScaleData() %>% 
  RunPCA() %>% 
  RunUMAP(dims = 1:20) %>% 
  FindNeighbors(dims = 1:20) 
```

```{r}
to_plot <- c(
  "pretty_cell_labels",
  "sample_type",
  "Krt8",
  "Cldn4",
  "Hopx",
  "Sftpc"
)

p  <- plot_umap(so2, 
                   to_plot[1:2], 
                   sorted = "random", 
                   pt_size = 0.0001, 
                   pt_alpha = 0.5, 
                   legend_title = "") 

p <- append(p, plot_umap(so2, to_plot[3:6],  sorted = "random"))

p <- plot_grid(plotlist = p, 
          nrow = 3,
          ncol = 3)
dir.create("Wu_et_al_cell/asbestos_figs")
save_plot("Wu_et_al_cell/asbestos_figs/merged_nonharmonized_umaps.pdf",
          p,
          nrow = 3,
          ncol = 3,
          base_asp = 1.5)

```


```{r}
library(harmony)

so2 <- RunHarmony(so2,
             group.by.vars = "study",
             dims.use = 1:20,
             theta = 1)
so2 <- FindNeighbors(so2, reduction = "harmony", dims = 1:20) %>%
  RunUMAP(dims = 1:20,
          reduction = "harmony",
          reduction.name = "harmony_umap")

so2 <- FindClusters(so2, 
               resolution = c(0.1, 0.3, 0.5, 0.7, 0.9, 1.1))
# 
# cell_type_order <- c(
#  "Naive AEC1",
#   "Injured AEC2: Proliferating",
#   "Injured AEC2: Late Transdifferentiating",
#   "Other Injured AEC2",
#   "Wu_et_al:AEC2",
#   "Naive AEC2",
#   "Injured AEC2: Early Transdifferentiating",
#   "Joshi_et_al:AEC2"
# )
# 
# so2$pretty_cell_labels <- factor(so2$pretty_cell_labels, levels = cell_type_order)
# so2$pretty_cell_labels <- as.character(so2$pretty_cell_labels)
# 
# palette_OkabeIto_cell_labels <- palette_OkabeIto[match(cells_to_keep, cell_type_order)]
# plot_harmony(so2, "pretty_cell_labels", sorted = "random", 
#              .cols = palette_OkabeIto_cell_labels)
```

```{r}
to_plot <- c(
  "pretty_cell_labels",
  "sample_type",
  "Krt8",
  "Cldn4",
  "Hopx",
  "Sftpc"
)

p  <- plot_harmony(so2, 
                   to_plot[1:2], 
                   sorted = "random", 
                   pt_size = 0.0001, 
                   pt_alpha = 0.5, 
                   legend_title = "") 

p <- append(p, plot_harmony(so2, to_plot[3:6],  sorted = "random"))

p <- plot_grid(plotlist = p, 
          nrow = 3,
          ncol = 3)

save_plot("Wu_et_al_cell/asbestos_figs/merged_harmonized_umaps.pdf",
          p,
          nrow = 3,
          ncol = 3,
          base_asp = 1.5)
p
```
 make a bunch of umaps split by study
 
 discrete stuff
```{r}

to_plot <- c(
  "pretty_cell_labels",
  "sample_type"
)

p <- map(to_plot,
    ~plot_harmony(so2, .x, group = "study",
          sorted = "random", 
          pt_size = 0.1)) %>% 
  plot_grid(plotlist = ., 
            nrow = length(to_plot),
            ncol = 1) 
p

save_plot("Wu_et_al_cell/asbestos_figs/merged_harmonized_umap_split_by_study.pdf",
          p,
          nrow = length(to_plot),
          ncol = 1,
          base_asp = 2.0,
          limitsize = FALSE)
```


```{r}
to_plot <- c("S100a6",
             "Sfn",
             "Tmsb10",
             "Anxa1",
             "Cldn4",
             "Clu",
             "AW112010",
             "Krt8",
             "Krt19",
             "Krt18",
             "Krt7",
             "Tnip3",
             "Tpm2",
             "Lgals1",
             "Sprr1a",
             "Anxa2",
             "Epcam",
             "Lgals3",
             "Hspb1",
             "2200002D01Rik")

p <- map(to_plot,
    ~plot_harmony(so2, .x, group = "study",
          sorted = "random", 
          pt_size = 0.1)) %>% 
  plot_grid(plotlist = ., 
            nrow = length(to_plot),
            ncol = 1) 
p

save_plot("Wu_et_al_cell/asbestos_figs/merged_harmonized_umap_split_by_study_top_genes.pdf",
          p,
          nrow = length(to_plot),
          ncol = 1,
          base_asp = 2.0,
          limitsize = FALSE)
```
