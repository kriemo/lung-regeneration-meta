---
title: "Meta-analysis of murine lung regeneration studies: Figures"
author: "Kent Riemondy"
date: "`r Sys.Date()`"
knit: (function(inputFile, encoding) {
  rmarkdown::render(inputFile, encoding = encoding, output_dir = "html") })
output:
  html_document:
    toc: true
    toc_float: true
    toc_depth: 3
    theme: cosmo
    highlight: kate
    fig_caption: true
    code_folding: hide
    df_print: paged
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_chunk$set(cache = FALSE)
```

```{r, results = 'hide', message = FALSE, warnings = FALSE}
library(ComplexHeatmap)
library(SingleCellExperiment)
library(scran)
library(scuttle)
library(scater)
library(batchelor)
library(data.table)
library(here)
library(openxlsx)
library(cowplot)
data_dir <- here("data")
formatted_data_dir <- "processed_data"
fig_dir <- "figs"
obj_dir <- "objects"
mkrs_dir <- "tables"
```

## Heatmaps (scVI)

Using 8 clusters.

```{r}
scvi_sce <- readRDS(file.path(obj_dir, "20221230_scvi_sce.rds"))
scanvi_sce <- readRDS(file.path(obj_dir, "20221230_scanvi_sce.rds"))
```


```{r}
fig_7b_genes <- c("Cdkn1a", "Cdkn2a", "Cdkn2b", "Trp53")

fig_7d_genes <- c("Fn1", "Tmsb10", "Clu", "Ctgf", "Igfbp6", "Sox4", "Crlf1", "Pmepa1", "Adgrg1", "Tmsb4x", "Sfn", "Lgals1", "Rab1a", "Cldn4", "Rsrp1", "Sparc", "Fblim1", "Cyba", "Ramp1", "Pdgfb", "Serpinb9", "Lpcat4", "Ntm", "Marcksl1", "Mcam", "Pdlim7")

fig_7j_genes <- c("Krt17", "Tpm1", "Sox4", "Cald1", "Sfn", "Fhl2", "Plau", "Phlda2", "Itga2", "Lamb3", "S100a2", "Atf3", "Zfp36l2", "Tpm4", "Palld", "Cdh3", "Ier3")

fig_7l_genes <- c("Hopx", "Igfbp2", "Pdpn", "Sftpc", "Lamp3", "Sftpb", "Sftpd", "Abca3", "Itgb6", "Cldn4", "Krt8", "Krt7", "Tpm1", "Cald1", "Fhl2", "S100a2", "Tpm4", "Krt17", "Lamb3", "Zfp36l2", "Itga2")
genes_to_plot <- list(fig_7b_genes = fig_7b_genes,
                      fig_7d_genes = fig_7d_genes,
                      fig_7j_genes = fig_7j_genes,
                      fig_7l_genes = fig_7l_genes)

genes_to_plot <- lapply(genes_to_plot, function(x){
  missing_genes <- setdiff(x, rownames(scvi_sce))
  if(length(missing_genes) > 0){
    msg <- paste0(missing_genes, collapse = ", ")
    warning("unable to find ", msg, " in matrix")
  }
  intersect(rownames(scvi_sce), x)
})


for(i in seq_along(genes_to_plot)){
  id <- names(genes_to_plot)[i]
  gns <- genes_to_plot[[i]]
  p <- plotGroupedHeatmap(scvi_sce,
                          features =gns, 
                          group = "clusters_8",
                          center = TRUE,
                          scale = TRUE, 
                          zlim = c(-2.5, 2.5), 
                          cluster_cols = FALSE,
                          colour = viridis::magma(101), 
                     main = id)
  p
}

```

<br>
<br>

## Heatmaps (scanVI)

Using 9 clusters. 

```{r}

for(i in seq_along(genes_to_plot)){
  id <- names(genes_to_plot)[i]
  gns <- genes_to_plot[[i]]
  plotGroupedHeatmap(scanvi_sce,
                          features = gns, 
                          group = "clusters_9",
                          center = TRUE,
                          scale = TRUE, 
                          zlim = c(-2.5, 2.5), 
                          cluster_cols = FALSE,
                          colour = viridis::magma(101), 
                          main = id)
}

```

## Compare transitional to abberant baseloid cells

Using 8 clusters for scvi and 9 clustersing for scanVI. The transitional cells are in cluster 7 (for both) and the abberant basaloid cells are in cluster 1 (both integrations)


### scvi 

```{r}
int_method <- "scvi"
mkrs <- scoreMarkers(scvi_sce, scvi_sce$clusters_8,
                         block = scvi_sce$study,
                         pairings = list("7", "1")) |>
  lapply(function(x){
        x <- as.data.frame(x)  
        x <- cbind(gene = rownames(x), x)
        x <- x[x$max.AUC > 0.5, ]
        x <- x[order(-x$max.logFC.cohen, -x$max.AUC), ]
        x <- x[1:100, ]
      })

names(mkrs) <- "ab_basaloid(7)_v_trans(1)"

mkrs |> 
  rbindlist(use.names = TRUE, idcol = "cluster") |>
  fwrite(file.path(mkrs_dir, int_method,
                   "aberrant_basaloid_v_transitional_markers.csv"), sep = ",")
    
openxlsx::write.xlsx(mkrs, file.path(mkrs_dir, 
                                         int_method, 
                                         "aberrant_basaloid_v_transitional_markers.xlsx"),
                         overwrite = TRUE)
```

### Heatmap (top 30)

Top 30 genes ranked on fold-change 

```{r}
gns <- mkrs[[1]][1:30, ]$gene
plotGroupedHeatmap(scvi_sce,
                   features = gns, 
                   group = "clusters_8",
                   center = TRUE,
                   scale = TRUE, 
                   zlim = c(-2.5, 2.5), 
                   cluster_cols = FALSE,
                   colour = viridis::magma(101), 
                   main = "Abberant Basaloid (c7) v Transitional (c1)")
```

### Violin plots per gene (top 30) {.tabset}

```{r, results ='asis', echo = FALSE}
for(i in seq_along(gns)){
  cat('\n#### ', gns[i], '\n')
  p <- plotExpression(scvi_sce, 
                      x = "clusters_8", 
                      features = gns[i], 
                      color_by = "clusters_8") +
    theme(legend.position = "none")
  print(p)
  cat('\n')
}
```


### scanvi 

```{r}
int_method <- "scanvi"
mkrs <- scoreMarkers(scanvi_sce, scanvi_sce$clusters_9,
                         block = scanvi_sce$study,
                         pairings = list("7", "1")) |>
  lapply(function(x){
        x <- as.data.frame(x)  
        x <- cbind(gene = rownames(x), x)
        x <- x[x$max.AUC > 0.5, ]
        x <- x[order(-x$max.logFC.cohen, -x$max.AUC), ]
        x <- x[1:100, ]
      })

names(mkrs) <- "ab_basaloid(7)_v_trans(1)"

mkrs |> 
  rbindlist(use.names = TRUE, idcol = "cluster") |>
  fwrite(file.path(mkrs_dir, int_method,
                   "aberrant_basaloid_v_transitional_markers.csv"), sep = ",")
    
openxlsx::write.xlsx(mkrs, file.path(mkrs_dir, 
                                         int_method, 
                                         "aberrant_basaloid_v_transitional_markers.xlsx"),
                         overwrite = TRUE)
    
```


### Heatmap (top 30)

Top 30 genes ranked on fold-change 

```{r}
gns <- mkrs[[1]][1:30, ]$gene
plotGroupedHeatmap(scanvi_sce,
                   features = gns, 
                   group = "clusters_9",
                   center = TRUE,
                   scale = TRUE, 
                   zlim = c(-2.5, 2.5), 
                   cluster_cols = FALSE,
                   colour = viridis::magma(101), 
                   main = "Abberant Basaloid (c7) v Transitional (c1)")
```

### Violin plots per gene (top 30) {.tabset}

```{r, results ='asis', echo = FALSE}
for(i in seq_along(gns)){
  cat('\n#### ', gns[i], '\n')
  p <- plotExpression(scanvi_sce, 
                      x = "clusters_9", 
                      features = gns[i], 
                      color_by = "clusters_9") +
    theme(legend.position = "none")
  print(p)
  cat('\n')
}
```

## session info

<details><summary>Show session info</summary>

```{r code}
sessionInfo()
```

</details>

