---
title: "Meta-analysis of murine lung regeneration studies"
author: "Kent Riemondy RBI"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_chunk$set(cache = TRUE)
```

```{r}
library(ComplexHeatmap)
library(SingleCellExperiment)
library(scran)
library(scuttle)
library(scater)
library(data.table)
library(here)
library(readxl)
library(openxlsx)
data_dir <- here("data")
formatted_data_dir <- "processed_data"
fig_dir <- "figs"

dir.create(fig_dir, showWarnings = FALSE)
dir.create(formatted_data_dir, showWarnings = FALSE)

obj_dir <- "objects"
dir.create(obj_dir, showWarnings = FALSE)
```

## Gene lists

```{r}
studies <- c(
  "Kobayashi_et_al_ncb" = "41556_2020_542_MOESM2_ESM.xlsx",
  "Riemondy_et_al_JCI-insight" = "2.14.2019_Suppl_Table_5.xlsx",
  "Strunz_et_al_nc" = "41467_2020_17358_MOESM4_ESM.xlsx",
  "Wu_et_al_cell" = "Nan Tang Table S2.xlsx"
  )

studies <- setNames(file.path(data_dir, names(studies), studies), names(studies))

combined_markers <- list()
combined_tables <- list()
combined_expression <- list()
```

## Kobayashi_et_al_ncb


>Kobayashi, Y., Tata, A., Konkimalla, A. et al. Persistence of a regeneration-associated, transitional alveolar epithelial cell state in pulmonary fibrosis. Nat Cell Biol 22, 934–946 (2020). https://doi.org/10.1038/s41556-020-0542-8

Found a transitional cell state in epithelial lung organoids. 

```{r}
study_id <- "Kobayashi_et_al_ncb"
mkrs <- studies[[study_id]]

tbl <- read_excel(mkrs, skip = 1)[, 1:4] |> as.list()
names(tbl) <- gsub("...[0-9]$", "", names(tbl))
tbl <- lapply(seq_along(tbl), function(i){
  x <- tbl[[i]]
  data.frame(cell_type = names(tbl)[i],
             gene = x[!is.na(x)])
})
tbl <- do.call(rbind, tbl)

combined_markers[[study_id]] <- tbl[tbl$cell_type == "PATS", ]$gene
combined_tables[[study_id]] <- tbl

sce_fn <- file.path(data_dir, study_id, "sce.rds")
if(!file.exists(sce_fn)) source(file.path(data_dir, "process_ncb.R"))
sce <- readRDS(sce_fn)
avg_expr <- assay(aggregateAcrossCells(sce,
                                       ids = sce$cell_type,
                                       statistics = "mean",
                                       use.assay.type = "logcounts")) |>
  as.data.frame()

colnames(avg_expr) <- paste0(study_id, "::", colnames(avg_expr))
combined_expression[[study_id]] <- avg_expr
```

## Riemondy_et_al_JCI-insight

```{r}
study_id <- "Riemondy_et_al_JCI-insight"
mkrs <- studies[[study_id]]

tbl <- read_excel(mkrs, sheet = 2,
                  col_names = c(
                    "Gene",
                    "avg_logFC",
                    "pct1",
                    "pct2",
                    "pval",
                    "adj_p_val"
                  ), skip = 1) 
tbl <- tbl[tbl$adj_p_val < 0.05, ]
tbl <- tbl[order(tbl$adj_p_val), ] 
tbl <- as.data.frame(tbl)

combined_markers[[study_id]] <-tbl$Gene
combined_tables[[study_id]] <- tbl

sce_fn <- file.path(data_dir, study_id, "sce.rds")
if(!file.exists(sce_fn)) source(file.path(data_dir, "process_jci-insight.R"))
sce <- readRDS(sce_fn)

avg_expr <- assay(aggregateAcrossCells(sce,
                                       ids = sce$pretty_cell_labels,
                                       statistics = "mean",
                                       use.assay.type = "logcounts")) |>
  as.data.frame()

avg_expr <- avg_expr[, c("Naive AEC1",
                         "Naive AEC2",
                         "Injured AEC2: Early Transdifferentiating",
                         "Injured AEC2: Late Transdifferentiating", 
                         "Injured AEC2: Proliferating", 
                         "Other Injured AEC2"), drop = FALSE]
colnames(avg_expr) <- paste0(study_id, "::", colnames(avg_expr))
combined_expression[[study_id]] <- avg_expr
```

## Strunz_et_al_nc


>
Strunz M, Simon LM, Ansari M, et al. Alveolar regeneration through a Krt8+ transitional stem cell state that persists in human lung fibrosis. Nat Commun [Internet]. 2020;11:3559. Available from: http://dx.doi.org/10.1038/s41467-020-17358-3.

```{r}
study_id <- "Strunz_et_al_nc"
mkrs <- studies[[study_id]]

tbl <- read_excel(mkrs, sheet = 2)

to_keep <- tbl$`annotated cluster` ==	"Krt8+ ADI" & 
  tbl$p_val_adj < 0.05 & 
  tbl$avg_logFC > 0

tbl <- tbl[to_keep, ]
tbl <- tbl[order(tbl$p_val_adj), ] 
tbl <- as.data.frame(tbl)

combined_markers[[study_id]] <- tbl$gene
combined_tables[[study_id]] <- tbl


sce_fn <- file.path(data_dir, study_id, "sce.rds")
if(!file.exists(sce_fn)) source(file.path(data_dir, "process_nc.R"))

sce <- readRDS(file.path(data_dir, study_id, "sce.rds"))
avg_expr <- assay(aggregateAcrossCells(sce,
                                       ids = sce$cell_type,
                                       statistics = "mean",
                                       use.assay.type = "logcounts")) |>
  as.data.frame()

avg_expr <- avg_expr[,
                     c("Krt8+ ADI",
                       "AT1",
                       "AT2",
                       "AT2 activated",
                       "Mki67+ Proliferation")]
colnames(avg_expr) <- paste0(study_id, "::", colnames(avg_expr))
combined_expression[[study_id]] <- avg_expr
```

## Wu_et_al_cell

>Wu H, Yu Y, Huang H, et al. Progressive Pulmonary Fibrosis Is Caused by Elevated Mechanical Tension on Alveolar Stem Cells. Cell [Internet]. 2020;180:107–121.e17. Available from: http://dx.doi.org/10.1016/j.cell.2019.11.027.

```{r}
study_id <- "Wu_et_al_cell"
mkrs <- studies[[study_id]]

tbl <- read_excel(mkrs, skip = 1) 
tbl <- tbl[tbl$`fold change (subpopulation I AT2 cells/subpopulation II AT2 cells)` > 0, ]

combined_markers[[study_id]] <- tbl$`Gene name`
combined_tables[[study_id]] <- tbl

avg_expr_d7 <- read_excel(file.path(data_dir, study_id, "C7.average.exp.xlsx"))
colnames(avg_expr_d7)[1] <- "mouse_gene_name" 
colnames(avg_expr_d7)[2:3] <- paste0(study_id, "::", colnames(avg_expr_d7)[2:3], "_d7")


sce_fn <- file.path(data_dir, study_id, "sce.rds")
if(!file.exists(sce_fn)) source(file.path(data_dir, "process_cell.R"))

so_fn <- file.path(data_dir, study_id, "so.rds")
if(!file.exists(so_fn)){
  # also process d21 data
  mat <- read_csv(file.path(data_dir,  study_id, "matrix.tsv.gz"))
  mat <- column_to_rownames(mat, "X1") 
  mat <- as.matrix(mat)
  mat <- as(mat, "sparseMatrix")
  
  mdata <- read_csv(file.path(data_dir, study_id, "meta_info_C0_C7_C21.csv")) %>% 
    dplyr::select(cell = X1, sample_name, cell_type) %>% 
    filter(cell %in% colnames(mat)) %>% 
    as.data.frame() %>% 
    column_to_rownames("cell") 
  
  mat <- mat[, rownames(mdata)]
  so <- CreateSeuratObject(mat, meta.data = mdata) %>% 
    NormalizeData()
  
    # also process at1 cells from previous pub (no metadata :( )
  at1_mat <- read_csv(file.path(data_dir,  study_id, "at1_data", "GSM2858341_AT1_P60.exprs.csv"))
  at1_mat <- column_to_rownames(at1_mat, "X1") %>% 
    as.matrix(.) %>% 
    as(., "sparseMatrix")
  so_at1 <- CreateSeuratObject(at1_mat)
  so_at1 <- FindVariableFeatures(so_at1) %>% 
    ScaleData() %>% 
    RunPCA(seed.value = 42) %>% 
    RunUMAP(dims = 1:10, seed.value = 42) %>% 
    FindNeighbors() %>% 
    FindClusters(resolution = c(0.05, 0.1, 0.2), random.seed = 42)
  so_at1$cell_type <- ifelse(so_at1$RNA_snn_res.0.2 %in% c("0", "1", "2", "4"),
                             "AT1",
                             "other")
  so_at1 <- subset(so_at1, 
                   subset = cell_type == "AT1")
  # get rid of a few outliers
  to_drop <- c("CAGGTGCCATTACGAC",
    "CTAGCCTGTGTTTGGT",
    "GTACGTAGTTCCGGCA",
    "TGGGAAGAGAAGAAGC")

  so_at1 <- subset(so_at1, cells = to_drop, invert = TRUE)
  
  so <- merge(so, so_at1)
  
  saveRDS(so, so_fn)
}

so <- readRDS(so_fn)
Idents(so) <- "cell_type"
avg_expr <- AverageExpression(so)$RNA
avg_expr <- as.data.frame(avg_expr)
#avg_expr <- avg_expr[, "population II", drop = FALSE]
colnames(avg_expr)[1:2] <- paste0(study_id, "::", colnames(avg_expr)[1:2], "_d21") %>% 
  str_replace_all(" ", "_")
colnames(avg_expr)[3] <- paste0(study_id, "::", colnames(avg_expr[3]))
avg_expr <- rownames_to_column(avg_expr, "mouse_gene_name")
avg_expr_d21 <- left_join(avg_expr, orthologs, by = "mouse_gene_name")
avg_expr <- left_join(avg_expr_d21, avg_expr_d7, by = "mouse_gene_name")
combined_expression[[study_id]] <- avg_expr
```


## Save 

```{r}
saveRDS(combined_markers, file.path(formatted_data_dir, "gene_lists.rds"))
saveRDS(combined_tables, file.path(formatted_data_dir, "gene_tables.rds"))
saveRDS(combined_expression, file.path(formatted_data_dir, "avg_expression.rds"))
```

```{r}

combined_markers <- readRDS(file.path('processed_data', "gene_lists.rds"))

library(eulerr)
#combined_markers <- map(combined_markers, ~.x[1:98])
fit <- venn(combined_markers[mouse_studies])
pdf(file.path(fig_dir, "marker_overlap_mouse_studies.pdf"))
plot(fit, 
     labels = TRUE,
     quantities = TRUE,
     fills = list(fill = palette_OkabeIto[1:4],
                  alpha = 0.5))
dev.off()


fit <- venn(map(combined_markers[mouse_studies], ~.x[1:50]))
pdf(file.path(fig_dir, "marker_overlap_mouse_studies_pvalue_top50.pdf"))
plot(fit, 
     labels = TRUE,
     quantities = TRUE,
     fills = list(fill = palette_OkabeIto[1:4],
                  alpha = 0.5))
dev.off()


fit <- euler(combined_markers[human_studies])
pdf(file.path(fig_dir, "marker_overlap_human_studies.pdf"))
plot(fit, 
     labels = TRUE,
     quantities = TRUE,
     fills = list(fill = palette_OkabeIto[1:6],
                  alpha = 0.5))
dev.off()


markers_shared <- Reduce(intersect, combined_markers[mouse_studies])

all_markers <- unlist(combined_markers[mouse_studies], use.names = FALSE) %>% unique()

                      
mrkr_lgl <- imap(combined_markers[mouse_studies],
    function(x, id) {
      df <- data.frame(tmp = all_markers %in% x, 
                       row.names = all_markers)
      colnames(df) <- id
      df}) %>% 
  do.call(cbind, .)

markers_3_of_4 <- mrkr_lgl[rowSums(mrkr_lgl) == 3, ] %>% 
  rownames_to_column("gene")

openxlsx::write.xlsx(list(shared_markers = markers_shared,
     shared_3_of_4 = markers_3_of_4),
     file.path(fig_dir, "shared_genes.xlsx"))
```

```{r, eval = FALSE}
combined_tables <- readRDS(file.path('processed_data', "gene_tables.rds"))
mouse_markers_fc <- list()

mouse_markers_fc$`Joshi_et_al_european-r-j`  <- combined_tables$`Joshi_et_al_european-r-j` %>% 
  filter(p_val_adj < 0.05) %>% 
  arrange(desc(avg_logFC)) %>% 
  pull(1)

mouse_markers_fc$`Riemondy_et_al_JCI-insight` <- combined_tables$`Riemondy_et_al_JCI-insight` %>% 
  filter(adj_p_val < 0.05) %>% 
  arrange(desc(avg_logFC)) %>% 
  pull(1)

mouse_markers_fc$Strunz_et_al_bioRxiv <- combined_tables$Strunz_et_al_bioRxiv %>% 
    filter(p_val_adj < 0.05) %>% 
  arrange(desc(avg_logFC)) %>% 
  pull(1)

mouse_markers_fc$Wu_et_al_cell <- combined_tables$Wu_et_al_cell %>% 
  arrange(desc(`fold change (subpopulation I AT2 cells/subpopulation II AT2 cells)`)) %>% 
  pull(1)



fit <- venn(map(mouse_markers_fc, ~.x[1:50]))
pdf(file.path(fig_dir, "marker_overlap_mouse_studies_fold_change_top50.pdf"))
plot(fit, 
     labels = TRUE,
     quantities = TRUE,
     fills = list(fill = palette_OkabeIto[1:4],
                  alpha = 0.5))
dev.off()

```


```{r, eval = FALSE}
library(gprofiler2)

if(!file.exists("go_results.rds")) {
  to_profile <- c(
    combined_markers[mouse_studies], 
    list(conserved_markers = markers_shared),
    list(mostly_conserved_markers = markers_3_of_4$gene))
  
  
  # use top 500 genes (or length if less than 500)
  to_profile <- map(to_profile, ~.x[1:min(length(.x), 500)])
  
  go_res <- gost(to_profile, 
                 organism = "mmusculus",
                 significant = FALSE)
  
  go_res <- split(go_res$result, go_res$result$query)
  saveRDS(go_res, "go_results.rds")
}

go_res <- readRDS("go_results.rds")

iwalk(go_res,
     function(gres, id){
       x <- split(gres, gres$source)
       names(x) <- str_replace(names(x), ":", "_")
       write.xlsx(x, file.path(fig_dir, str_c("geneset_enrichment_results_", id, ".xlsx")))
     })
```


## Average expression per cluster


```{r}
combined_expression <- readRDS(file.path(formatted_data_dir, "avg_expression.rds"))


shared_genes <- map(combined_expression[mouse_studies[2:4]], ~.x$mouse_gene_name) %>% Reduce(intersect, .)

combined_expr <- imap(combined_expression[3:6], ~.x[!is.na(.x$mouse_gene_name), ] %>% 
      as.data.frame() %>% 
      filter(mouse_gene_name %in% shared_genes) %>% 
      dplyr::select(mouse_gene_name, contains(.y)) %>% 
      column_to_rownames("mouse_gene_name") %>% 
        .[shared_genes, , drop = FALSE]) %>% 
  unname() %>% 
  do.call(cbind, .)

combined_expr <- combined_expr[rowSums(is.na(combined_expr)) == 0, ]

# var_genes <- order(-apply(combined_expr, 1, var))[1:1000]
# combined_expr <- combined_expr[var_genes, ]

cres <- cor(combined_expr, method = "pearson")

hmap <- Heatmap(cres,
        col = viridis::viridis(256),
        name = "Correlation\n(Pearson)",
         row_names_gp = gpar(fontsize = 6),
        column_names_gp = gpar(fontsize = 6),
        heatmap_legend_param = list( labels_gp = gpar(fontsize = 6)))

hmap

pdf(file.path(fig_dir, "cell_type_correlation_mouse.pdf"),
    width = 10,
    height = 8)
draw(hmap, heatmap_legend_side = "left")
dev.off()
```

#### Specific marker heatmap

```{r}
to_plot <- c(
  "Sftpc",
  "Sftpd",
#  "C5",
  "Abca3",
  "Krt8",
  "Cldn4",
  "Sox4",
  "Itgb6",
  "Hopx",
  "Ager",
  "Akap5",
  "Pdpn")

zscore <- t(scale(t(combined_expr[to_plot, ])))

hmap <- Heatmap(zscore,
        col = viridis::viridis(256),
        name = "Z-score",
         row_names_gp = gpar(fontsize = 8),
        column_names_gp = gpar(fontsize = 8),
        row_names_side = "left",
        heatmap_legend_param = list( labels_gp = gpar(fontsize = 8)))

hmap


pdf(file.path(fig_dir, "cell_type_markers_heatmap_mouse.pdf"),
    width = 8,
    height = 8)
draw(hmap, heatmap_legend_side = "left")
dev.off()
```


### PCA plot

```{r}
library(ggrepel)
var_genes <- order(-apply(combined_expr, 1, var))[1:500]
zscores <- scale(t(combined_expr[var_genes, ]))
pc <- prcomp(zscores)

cell_types <- c("Joshi_et_al_european-r-j::AT2_2" = "Injured AT2",
  "Joshi_et_al_european-r-j::AT2_1" = "Injured AT2",
  "Joshi_et_al_european-r-j::AT2_3" = "CCA",
  "Joshi_et_al_european-r-j::AT2_4" = "Injured AT2",
  "Joshi_et_al_european-r-j::AT1" = "Naive AT1",
  "Riemondy_et_al_JCI-insight::Naive AEC1" = "Naive AT1",
  "Riemondy_et_al_JCI-insight::Naive AEC2" = "Naive AT2",
  "Riemondy_et_al_JCI-insight::Injured AEC2: Early Transdifferentiating" = "CCA",
  "Strunz_et_al_bioRxiv::Krt8_c4-epi-timecourse" = "CCA",
  "Strunz_et_al_bioRxiv::AT1-epi-timecourse" = "Naive AT1",
  "Strunz_et_al_bioRxiv::AT2-epi-timecourse" = "Naive AT2",
  "Strunz_et_al_bioRxiv::Krt8_c9-epi-timecourse" = "CCA",
  "Strunz_et_al_bioRxiv::AT2-whole-lung" = "Naive AT2",
  "Strunz_et_al_bioRxiv::Krt8-whole-lung" = "CCA",
  "Strunz_et_al_bioRxiv::AT1-whole-lung" = "Naive AT1",
  "Strunz_et_al_bioRxiv::AT2-injured-whole-lung" = "Injured AT2",
  "Wu_et_al_cell::population_I_d21" = "Injured AT2",
  "Wu_et_al_cell::population_II_d21" = "Injured AT2",
  "Wu_et_al_cell::AT1" = "Naive AT1",
  "Wu_et_al_cell::subpopulation I_d7" = "Injured AT2",
  "Wu_et_al_cell::subpopulation II_d7" = "Injured AT2")

cell_type_metadata <- tibble(
  study = names(combined_expr)) %>% 
  mutate(cell_types = cell_types[study])


pc$x %>% 
  as.data.frame() %>% 
  rownames_to_column("study") %>% 
  left_join(cell_type_metadata) %>% 
  ggplot(aes(PC1, PC2)) +
  geom_point(aes(color = cell_types)) 
```

## Try to co-embed all mouse data

```{r, harmonize, cache.lazy=FALSE}


so_fn <-  file.path(obj_dir, "harmonized.rds")

to_integrate <- c("Kobayashi_et_al_ncb",
                  "Riemondy_et_al_JCI-insight",
                  "Strunz_et_al_nc")

study_specific_cell_types <- list(
  "Kobayashi_et_al_ncb" = c(
    "AEC1",
    "AEC2",
    "PATS-2",
    "PATS-1",
    "AEC2-proliferating"
  ),
  "Riemondy_et_al_JCI-insight" =   c(
    "Naive AEC1",
    "Naive AEC2",
    "Injured AEC2: Early Transdifferentiating",
    "Injured AEC2: Late Transdifferentiating",
    "Injured AEC2: Proliferating",
    "Other Injured AEC2"
  ),
  "Strunz_et_al_nc" =  c(
    "Krt8 ADI",
    "Activated AT2 cells",
    "AT1 cells",
    "AT2 cells",
    "activated AT2",
    "proliferation"
  )
)

# study_specific_metadata <- list(
#   
# )
if(!file.exists(so_fn)){
  sos <- map(to_integrate, 
             ~readRDS(file.path(data_dir, .x, "so.rds")))
  names(sos) <- to_integrate
  sos <- pmap(list(sos, 
                   names(sos),
                   c("cell_type",
                     "pretty_cell_labels", 
                     "cell_type"),
                   study_specific_cell_types),
              function(so, id, cell_type_col, cell_types) {
                so@meta.data$study <- id
                so@meta.data$cell_type <- so@meta.data[[cell_type_col]]
                # so@meta.data <- so@meta.data[, 
                #                              c("orig.ident", "nCount_RNA", "nFeature_RNA", "study", "cell_type")]
                to_keep <- so$cell_type %in% cell_types
                so <- so[, to_keep]
                so})
  
  so <- merge(sos[[1]], y = sos)
  
  library(harmony)
  seed_value <- 20200806
  so <- FindVariableFeatures(so, nfeatures = 3000) %>% 
    ScaleData(.) %>% 
    RunPCA(., seed.use = seed_value) %>% 
    RunUMAP(., dims = 1:30, seed.use = seed_value)
  
  res_values <- seq(0.1, 1.5, by = 0.2)
  set.seed(seed_value)
  so <- RunHarmony(so, dims.use = 1:30, group.by.vars = "study")
  so <- RunUMAP(so, 
                dims = 1:30, 
                reduction = "harmony", 
                reduction.name = "harmony_umap", 
                seed.use = seed_value)
  
  so <- FindNeighbors(so, 
                      dims = 1:30, 
                      k.param = 30L, 
                      reduction = "harmony") %>% 
    FindClusters(resolution = res_values, 
                 random.seed = seed_value)
  
  # fix labels
  
  so$pretty_cell_labels <- case_when(
    so$study == "Riemondy_et_al_JCI-insight" ~ str_c("LPS:", so$cell_type),
    so$study == "Kobayashi_et_al_ncb" ~ str_c("Organoid:", so$cell_type),
    TRUE ~ so$pretty_cell_labels
  )
  saveRDS(so, file.path(obj_dir, "harmonized.rds"))
  rm(sos)
}
```

```{r, cache.lazy=FALSE}
so <- readRDS(file.path(obj_dir, "harmonized.rds"))
```


## Integrated UMAPs Krt8/18 markers {.tabset}

### Cell type not split
```{r, cache.lazy = FALSE}
to_plot <- c("pretty_cell_labels", "study")
umap_dir <- file.path(fig_dir, "umaps")
dir.create(umap_dir, showWarnings = FALSE)
pwalk(list(to_plot, 
      c(3.33, 1.75),
      c(2, 1)),
    function(x, y, z){
      p <- plot_harmony(so, x, sorted = "random", legend_title = "") +
        guides(color = guide_legend(ncol = z, override.aes = list(size = 4)))
      print(p)
      save_plot(file.path(umap_dir, str_c(x, "_not_split.pdf")),
                p,
                base_asp = y)
    })
```

```{r, results="asis", cache.lazy = FALSE}

iwalk(to_plot, 
    function(x, y){
      cat("\n### ", x, "\n")
      p <- plot_harmony(so, x, group = "study", sorted = "random", legend_title = "") +
        guides(color = guide_legend(ncol = c(2, 1)[y], override.aes = list(size = 4)))
      print(p)
      save_plot(file.path(umap_dir, str_c(x, "_split.pdf")),
                p,
                base_asp = c(5, 3)[y])
      cat('  \n')
    })
```

```{r, results="asis", cache.lazy = FALSE}
to_plot <- c("Hopx")

umap_dir <- file.path(fig_dir, "umaps")
dir.create(umap_dir, showWarnings = FALSE)
walk(to_plot, 
    function(x){
      cat("\n### ", x, "\n")
      p <- plot_harmony(so, x, group = "study", sorted = "random")
      print(p)
      save_plot(file.path(umap_dir, str_c(x, "_split.pdf")),
                p,
                base_asp = 1.5)
      cat('  \n')
    })
```

```{r, results="asis", cache.lazy = FALSE}
to_plot <- c("Hopx",
             "S100a6",
             "Sfn",
             "Tmsb10",
             "Anxa1",
             "Cldn4",
             "Clu",
             "AW112010",
             "Krt8",
             "Krt19",
             "Krt18",
             "Krt7",
             "Tnip3",
             "Tpm2",
             "Lgals1",
             "Sprr1a",
             "Anxa2",
             "Epcam",
             "Lgals3",
             "Hspb1",
             "2200002D01Rik",
             "Itgb1",
             "Sox4")

umap_dir <- file.path(fig_dir, "umaps")
dir.create(umap_dir, showWarnings = FALSE)
walk(to_plot, 
    function(x){
      cat("\n### ", x, "\n")
      p <- plot_harmony(so, x, group = "study", sorted = "random")
      print(p)
      save_plot(file.path(umap_dir, str_c(x, "_split.pdf")),
                p,
                base_asp = 3)
      cat('  \n')
    })
```
## Markers

```{r, cache.lazy = FALSE, fig.width = 10, fig.height= 10}
clustering_params <- str_subset(colnames(so@meta.data), "RNA_snn")
p <- plot_harmony(so, clustering_params) %>% 
  plot_grid(plotlist = .) 
p
save_plot(file.path(umap_dir, "clustering_parameters.pdf"),
          p,
          nrow = 3,
          ncol = 3,
          base_asp = 1.66)
```

```{r}
so$refined_clusters <- so$RNA_snn_res.1.3
so$coarse_clusters <- so$RNA_snn_res.0.5
saveRDS(so, file.path(obj_dir, "harmonized.rds"))

library(presto)
mkrs <- wilcoxauc(so, "refined_clusters")

top_mkrs <- mkrs %>% 
  filter(logFC > 0,
         padj < 0.05) %>% 
  group_by(group) %>% 
  arrange(padj, desc(logFC), .by_group = TRUE)

write_tsv(top_mkrs, file.path(fig_dir, "meta-analysis-refined-cluster-markers.tsv"))

mkrs <- wilcoxauc(so, "coarse_clusters")

top_mkrs <- mkrs %>% 
  filter(logFC > 0,
         padj < 0.05) %>% 
  group_by(group) %>% 
  arrange(padj, desc(logFC), .by_group = TRUE)

write_tsv(top_mkrs, file.path(fig_dir, "meta-analysis-coarse-cluster-markers.tsv"))
```

## Cell browser

```{r, eval = FALSE}
cb_outdir <- "cellbrowser"
dir.create(cb_outdir, showWarnings = FALSE)
so$study <- str_replace_all(so$study, "_", "-")
cols_to_keep <- c(
  `genes per cell` = "nFeature_RNA",
  `UMIs per cell` = "nCount_RNA",
  `cell-type` = "pretty_cell_labels",
  `study` = "study",
  `refined-clusters` = "refined_clusters",
  `coarse-clusters` = "coarse_clusters",
  `bleo-sample-info` = "grouping"
  )

make_cellbrowser(so, 
                 column_list = cols_to_keep,
                 project = "lung-meta-analysis",
                 outdir = cb_outdir,
                 marker_file = file.path(fig_dir, 
                                         "meta-analysis-refined-cluster-markers.tsv"),
                 ident = "refined-clusters",
                 embeddings = c("umap", "harmony_umap"),
                 skip_expr_matrix = TRUE,
                 config = list(priority = 1,  
                               radius = 2),
                 description = list(    
                   title = "Lung Injury meta-analysis",
                   description = "Includes unaligned and aligned (harmony_umap) projections"), 
                 cellbrowser_dir = "/miniconda3/envs/py37/bin"
)
```

```{r}
studies <- unique(so$study)
walk(studies, 
     ~{
       tmp <- subset(so, subset = study == .x)
       make_cellbrowser(tmp, 
                        column_list = cols_to_keep,
                        project = str_c("lung-meta-analysis-", .x) ,
                        outdir = cb_outdir,
                        marker_file = file.path(fig_dir, 
                                                "meta-analysis-refined-cluster-markers.tsv"),
                        ident = "refined-clusters",
                        embeddings = c("umap", "harmony_umap"),
                        skip_expr_matrix = FALSE,
                        config = list(priority = 1,  
                                      radius = 2),
                        description = list(    
                          title = .x,
                          description = "Includes unaligned and aligned (harmony_umap) projections"), 
                        cellbrowser_dir = "/miniconda3/envs/py37/bin"
       )})

```

```{r}
datasets <- file.path(cb_outdir,
                      c("lung-meta-analysis", str_c("lung-meta-analysis-", studies)),
                      "cellbrowser.conf")

build_cellbrowser(datasets, outdir = file.path(cb_outdir, "lung-meta"))
```


## Human


### Average expression per cluster


```{r}
combined_expression <- readRDS(file.path(formatted_data_dir, "avg_expression.rds"))

shared_genes <- map(combined_expression[1:2], 
                    ~.x$human_gene_name) %>% 
  Reduce(intersect, .)

combined_expr <- imap(combined_expression[1:2], 
                      ~.x[!is.na(.x$human_gene_name), ] %>% 
      as.data.frame() %>% 
      filter(human_gene_name %in% shared_genes) %>% 
      dplyr::select(human_gene_name, contains(.y)) %>% 
      column_to_rownames("human_gene_name") %>% 
        .[shared_genes, , drop = FALSE]) %>% 
  unname() %>% 
  do.call(cbind, .)

combined_expr <- combined_expr[rowSums(is.na(combined_expr)) == 0, ]

# var_genes <- order(-apply(combined_expr, 1, var))[1:1000]
# combined_expr <- combined_expr[var_genes, ]

cres <- cor(combined_expr, method = "pearson")

hmap <- Heatmap(cres,
        col = viridis::viridis(256),
        name = "Correlation\n(Pearson)",
         row_names_gp = gpar(fontsize = 6),
        column_names_gp = gpar(fontsize = 6),
        heatmap_legend_param = list( labels_gp = gpar(fontsize = 6)))

hmap

pdf(file.path(fig_dir, "cell_type_correlation_human.pdf"),
    width = 10,
    height = 8)
draw(hmap, heatmap_legend_side = "left")
dev.off()
```

### Specific marker heatmap

```{r}
to_plot <- c(
  "SFTPC",
  "SFTPD",
#  "C5",
  "ABCA3",
  "KRT8",
  "CLDN4",
  "SOX4",
  "ITGB6",
  "HOPX",
  "AGER",
  "AKAP5",
  "PDPN")

zscore <- t(scale(t(combined_expr[to_plot, ])))

hmap <- Heatmap(zscore,
        col = viridis::viridis(256),
        name = "Z-score",
         row_names_gp = gpar(fontsize = 8),
        column_names_gp = gpar(fontsize = 8),
        row_names_side = "left",
        heatmap_legend_param = list( labels_gp = gpar(fontsize = 8)))

hmap


pdf(file.path(fig_dir, "cell_type_markers_heatmap_human.pdf"),
    width = 8,
    height = 8)
draw(hmap, heatmap_legend_side = "left")
dev.off()
```


## Average expression per cluster for both


```{r}
combined_expression <- readRDS(file.path(formatted_data_dir, "avg_expression.rds"))

shared_genes <- map(combined_expression, 
                    ~.x$ortho_id) %>% 
  Reduce(intersect, .)

combined_expr <- imap(combined_expression, 
                      ~.x[!is.na(.x$ortho_id), ] %>% 
      as.data.frame() %>% 
      filter(ortho_id %in% shared_genes) %>% 
      dplyr::select(ortho_id, contains(.y)) %>% 
      column_to_rownames("ortho_id") %>% 
        .[shared_genes, , drop = FALSE]) %>% 
  unname() %>% 
  do.call(cbind, .)

combined_expr <- combined_expr[rowSums(is.na(combined_expr)) == 0, ]

# var_genes <- order(-apply(combined_expr, 1, var))[1:1000]
# combined_expr <- combined_expr[var_genes, ]

cres <- cor(combined_expr, method = "pearson")

hmap <- Heatmap(cres,
        col = viridis::viridis(256),
        name = "Correlation\n(Pearson)",
         row_names_gp = gpar(fontsize = 6),
        column_names_gp = gpar(fontsize = 6),
        heatmap_legend_param = list( labels_gp = gpar(fontsize = 6)))

hmap

pdf(file.path(fig_dir, "cell_type_correlation_human_mouse.pdf"),
    width = 10,
    height = 8)
draw(hmap, heatmap_legend_side = "left")
dev.off()
```



### Specific marker heatmap

```{r}
to_plot <- c(
  "SFTPC",
  "SFTPD",
#  "C5",
  "ABCA3",
  "KRT8",
  "CLDN4",
  "SOX4",
  "ITGB6",
  "HOPX",
  "AGER",
  "AKAP5",
  "PDPN")

to_plot <- c("SFTPC:Sftpc",
  "SFTPD:Sftpd",
  "ABCA3:Abca3",
  "KRT8:Krt8",
  "CLDN4:Cldn4",
  "SOX4:Sox4",
  "ITGB6:Itgb6",
  "HOPX:Hopx",
  "AGER:Ager",
  "AKAP5:Akap5",
  "PDPN:Pdpn")

zscore <- t(scale(t(combined_expr[to_plot, ])))

hmap <- Heatmap(zscore,
        col = viridis::viridis(256),
        name = "Z-score",
         row_names_gp = gpar(fontsize = 8),
        column_names_gp = gpar(fontsize = 8),
        row_names_side = "left",
        heatmap_legend_param = list( labels_gp = gpar(fontsize = 8)))

hmap


pdf(file.path(fig_dir, "cell_type_markers_heatmap_human_mouse.pdf"),
    width = 8,
    height = 8)
draw(hmap, heatmap_legend_side = "left")
dev.off()
```


### Marker overlap

```{r}
library(eulerr)

human_markers <- map2(combined_tables[human_studies], 
                     c("gene", "X1", "id"),
                     ~.x[[.y]])
fit <- euler(human_markers)
pdf(file.path(fig_dir, "marker_overlap_human_studies.pdf"))
plot(fit, 
     labels = TRUE,
     quantities = TRUE,
     fills = list(fill = palette_OkabeIto[1:6],
                  alpha = 0.5))
dev.off()

markers_shared_human <- Reduce(intersect, human_markers)

#get mouse ortholog for human gene
markers_shared_human <- left_join(tibble(human_gene_name = markers_shared_human),
          orthologs,
          by = c("human_gene_name"))

all_human_markers <- unlist(human_markers, use.names = FALSE) %>% unique()
                      
mrkr_lgl_human <- imap(human_markers,
    function(x, id) {
      df <- data.frame(tmp = all_human_markers %in% x, 
                       row.names = all_human_markers)
      colnames(df) <- id
      df}) %>% 
  do.call(cbind, .) %>% 
  rownames_to_column("gene")

markers_shared_mouse <- Reduce(intersect, combined_markers[mouse_studies])
# markers_shared_mouse_orthos <- left_join(tibble(mouse_gene_name = markers_shared_mouse),
#           orthologs,
#           by = c("mouse_gene_name"))

all_mouse_markers <- unlist(combined_markers[mouse_studies], use.names = FALSE) %>% unique()
                      
mrkr_lgl <- imap(combined_markers[mouse_studies],
    function(x, id) {
      df <- data.frame(tmp = all_mouse_markers %in% x, 
                       row.names = all_mouse_markers)
      colnames(df) <- id
      df}) %>% 
  do.call(cbind, .)

markers_3_of_4 <- mrkr_lgl[rowSums(mrkr_lgl) == 3, ] %>% 
  rownames_to_column("gene")

openxlsx::write.xlsx(list(
  shared_mouse_markers = markers_shared_mouse,
  mouse_shared_3_of_4 = markers_3_of_4,
  shared_human_markers = markers_shared_human,
  human_all_data = mrkr_lgl_human),
     file.path(fig_dir, "shared_genes.xlsx"))

```
